# ============================================
# GITHUB ACTIONS - Destroy Infrastructure
# ============================================
# Tears down infrastructure for a given environment.
# Use this to clean up and save costs.
#
# IMPORTANT: Destroy in reverse order!
#   1. PaaS + IaaS first (they depend on shared MySQL)
#   2. Shared MySQL last

name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to destroy"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      target:
        description: "What to destroy"
        required: true
        type: choice
        options:
          - all
          - shared-only
          - paas-only
          - iaas-only
      confirm:
        description: "Type the environment name to confirm destruction"
        required: true
        type: string

env:
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  TF_VAR_subscription_id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  TF_VAR_db_admin_password: ${{ secrets.DB_ADMIN_PASSWORD }}
  TF_VAR_app_key: ${{ secrets.APP_KEY }}
  TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Safety check
  validate:
    name: Validate confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: inputs.confirm != inputs.environment
        run: |
          echo "❌ Confirmation failed! You typed '${{ inputs.confirm }}' but expected '${{ inputs.environment }}'"
          exit 1
      - name: Confirmed
        run: echo "✅ Destruction of ${{ inputs.environment }} confirmed"

  # Destroy PaaS
  destroy-paas:
    name: "Destroy PaaS (${{ inputs.environment }})"
    runs-on: ubuntu-latest
    needs: [validate]
    if: inputs.target == 'all' || inputs.target == 'paas-only'
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false
      - uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }
      - name: Terraform Init & Destroy (PaaS)
        working-directory: terraform/paas
        run: |
          terraform init
          terraform workspace select ${{ inputs.environment }} || terraform workspace new ${{ inputs.environment }}
          terraform destroy -auto-approve -var-file=environments/${{ inputs.environment }}.tfvars

  # Destroy IaaS
  destroy-iaas:
    name: "Destroy IaaS (${{ inputs.environment }})"
    runs-on: ubuntu-latest
    needs: [validate]
    if: inputs.target == 'all' || inputs.target == 'iaas-only'
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false
      - uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }
      - name: Generate dummy SSH key (for terraform vars)
        run: ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
      - name: Terraform Init & Destroy (IaaS)
        working-directory: terraform/iaas
        run: |
          terraform init
          terraform workspace select ${{ inputs.environment }} || terraform workspace new ${{ inputs.environment }}
          terraform destroy -auto-approve -var-file=environments/${{ inputs.environment }}.tfvars

  # Destroy Shared (only after PaaS and IaaS are gone)
  destroy-shared:
    name: "Destroy Shared MySQL (${{ inputs.environment }})"
    runs-on: ubuntu-latest
    needs: [validate, destroy-paas, destroy-iaas]
    if: |
      always() &&
      inputs.environment != 'dev' &&
      (inputs.target == 'all' || inputs.target == 'shared-only')
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          terraform_wrapper: false
      - uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}"
            }
      - name: Terraform Init & Destroy (Shared)
        working-directory: terraform/shared
        run: |
          terraform init
          terraform workspace select ${{ inputs.environment }} || terraform workspace new ${{ inputs.environment }}
          terraform destroy -auto-approve -var-file=environments/${{ inputs.environment }}.tfvars
